angular.module("debate-visualization")
  .directive("wordcloud", () ->
    return {
        restrict: 'E',
        templateUrl: "<%= asset_path 'wordcloud/layout/layout.html' %>",
        scope: {
          words: '=',
          posColor: '=',
          negColor: "="
        },

        link: (scope, element, attrs) ->
          # Fit to available space
          wcRect    = element.children()[0].getBoundingClientRect();
          wcWidth   = wcRect.width;
          wcHeight  = wcWidth;

          scope.$watch('words', (newVal, oldVal) ->
            if newVal == undefined || newVal == null then return;

            # Colors
            posColor = scope.posColor.toHexString();
            posColorLight = scope.posColor.clone().lighten(50).toHexString();
            negColor = scope.negColor.toHexString();
            negColorLight = scope.negColor.clone().lighten(50).toHexString();

            # Linear interpolation for wordcloud
            color_scale_pos = d3.scale.linear()
              .domain([0,1])
              .range([posColorLight, posColor]);

            color_scale_neg = d3.scale.linear()
              .domain([0,-1])
              .range([negColorLight, negColor]);

            #TODO: Font scale - Implement when we have real data
            # !!!

            # Layout definition
            layout = d3.layout.cloud()
              .size([wcWidth, wcHeight])
              .words(scope.words)
              .padding(5)
              .rotate(() -> return ~~(Math.random() * 2) * 45;)
              .font("Impact")
              .fontSize((d) -> return d.size;)

            # Render Function
            draw = (words) ->
              d3.select(element.children()[0]).append("svg")
                .attr("width", layout.size()[0])
                .attr("height", layout.size()[1])
              .append("g")
                .attr("transform", "translate(" + layout.size()[0] / 2 + "," + layout.size()[1] / 2 + ")")
              .selectAll("text")
                .data(words)
              .enter().append("text")
                .style("font-size", (d) -> return d.size + "px";)
                .style("font-family", "Impact")
                .style("fill", (d, i) ->
                  return if d.sentiment > 0 then color_scale_pos(d.sentiment) else color_scale_neg(d.sentiment);
                )
                .attr("text-anchor", "middle")
                .attr("transform", (d) ->
                  return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                )
                .text( (d) -> return d.text;);
              scope.$emit("render-done", element);

            # Start layout and render
            layout.on("end", draw);
            layout.start();
          );
    };  # return
  );
